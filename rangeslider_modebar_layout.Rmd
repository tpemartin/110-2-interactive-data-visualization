# Range slider, modebar, and more layout 


```{r , eval=T, echo=F}
klippy::klippy()
tags$a(
  href="https://tpemartin.github.io/econIDV/foodprices2.html", target="_blank",
teachDS::img_centering2("./img/foodprices2.png", "100%"))
```


  * Ticks and grid lines
  
  * Traces and legend groups
  
  * Fixed axis range
  
  * Range slider and range selector buttons
  
  * Mix controls of legend group filtering and highlight
  
  * Custom modebar
  
## Prepare data

```{r}
examples = econIDV::Examples()
examples$agricultureProductPrices()
examples$agricultureProductPricesEnv$attach()
```

```{r}
download_agriculturePrices()

df_agPrices |>
  add_categories() -> df_agPrices
```


## Ticks and grid lines

```{r echo=F}
df_agPrices |> 
  filter(Cat=="魚") -> smalldf
names(smalldf)
smalldf |> 
  ggplot()+
  geom_line(
    aes(x=TIME_PERIOD,y=Item_VALUE,
      group=Item2)
  ) -> gg_raw
ggplotly(gg_raw) |>
plotly::layout(
  xaxis=list(
      type="date",
      gridwidth=0.1, gridcolor="#434343",
      showgrid=T, showline=T,
      dtick = "M12", # 座標點相隔12個月
      tickformat="%Y", # 座標只放年
      ticklabelmode="period", # 時間標在區間的中間
      title=list(text=NULL))
  )
```


```{r}
library(plotly)
df_agPrices |> 
  plotly::plot_ly() |>
    add_trace(
      type="scatter", mode="lines",
      x=~TIME_PERIOD,
      y=~Item_VALUE,
      name=~Item2, # trace名稱, 也是legend label
      split=~Item2, # 切割trace依據
      color=I("white"),
      legendgroup=~Cat, # 相同Cat合併成一trace.
      hovertemplate="%{x|%b%Y}",
      line=list(width=0.3)
    ) |>
  plotly::layout(
    legend=list(
      orientation="h"
    ),
    plot_bgcolor="black",
    yaxis=list(
      gridwidth=0.1, gridcolor="#434343",
      showgrid=T, showline=F,
      title=list(text=NULL)),
    xaxis=list(
      gridwidth=0.1, gridcolor="#434343",
      showgrid=T, showline=T,
      dtick = "M12", # 座標點相隔12個月
      tickformat="%Y", # 座標只放年
      ticklabelmode="period", # 時間標在區間的中間
      title=list(text=NULL))
  ) -> plt0
plt0 
```

<div class="alert alert-danger">
`ticklabelmode="period"`只對date class的座標有效，然而ggplotly()翻譯過去一定會把date class改成numeric class而無法使用`ticklabelmode="period"`，所以只能直接用plotly畫。
</div>

## Traces and Legend group

**Trace**: 在還沒有試定legend group（圖例）下，圖例所顯示的每一個可控制的圖形均為一個trace。

**Legend group**: 將traces圖例分群且圖例可控制範圍變成一群為一控制單位。

Get the mapping among trace names, legend groups and trace numbers:
```{r}
traceInfo = econIDV::get_traceInfo(plt0)
```

You can add legend group titles by:
```{r}
plt0 |> econIDV::add_legendgrouptitle() -> plt0_withLGtitles
plt0_withLGtitles
```

Legend group titles are added based on `traceInfo` generated by `get_traceInfo()`. You can change `traceInfo$legendgroup` to change the presentation of legend groups including its order (which is determined by `levels(traceInfo$legendgroup)`).
```{r}
movefront <-
  c(9,8,12,11,13,2,3,5:7,1)
levels(traceInfo$legendgroup)[
  c(movefront,
    (1:23)[-movefront])] -> newLevels
traceInfo$legendgroup <- factor(
  traceInfo$legendgroup,
  levels=newLevels
)
```

```{r}
plt0 |> 
  add_legendgrouptitle(traceInfo=traceInfo) -> plt0_withLGtitlesOrdered
plt0_withLGtitlesOrdered
```

## Fixed axis range


```{r}
plt0_withLGtitlesOrdered |>
  plotly::layout(
    yaxis=list(range=c(0,250))
  ) -> plt_fixedRange
plt_fixedRange
```

## Range slider

  * <https://plotly.com/r/range-slider/>
  
```{r, echo=F}
Rangeslider = function(){
  placeholder = new.env()
  placeholder$rangeslider=list(
    rangeslider = alist(type =),
    rangeselector=alist(
      buttons=))
  
  placeholder$add_buttons=function(n){
        rep(list(alist(
          count=, label=, step=, stepmode=
        )),n) ->
      placeholder$rangeslider$rangeselector$buttons
      }
  
  placeholder
}
rs = Rangeslider()
rs$add_buttons(4)
rs$rangeslider$rangeslider$type="date"
rs$rangeslider$rangeselector$buttons[[1]] <- list(3, "3mo", "month", "backward")
rs$rangeslider$rangeselector$buttons[1]
rs$rangeslider$rangeselector$buttons[2] <- list(list(3, "3mo", "month", "backward"))
rs$rangeslider$rangeselector$buttons[2]

`%<==%` = function(L,R){
  rlang::enquo(L) -> quoL
  
  browser()
  ce = rlang::caller_env()
  purrr::walk(seq_along(L), 
    ~{ce$L[[.x]]=R[[.x]]})
  L
}
  L=rs$rangeslider$rangeselector$buttons[[3]]
  R=list(3, "3mo", "month", "backward")
L %<==% R
```


```{r}
plt_fixedRange |> 
  plotly::layout(
    xaxis= list(
      rangeselector = list(
        buttons = list(
          list(
            count = 3,
            label = "3 mo",
            step = "month",
            stepmode = "backward"),
          list(
            count = 6,
            label = "6 mo",
            step = "month",
            stepmode = "backward"),
          list(
            count = 1,
            label = "1 yr",
            step = "year",
            stepmode = "backward"),
          list(
            count = 1,
            label = "YTD",
            step = "year",
            stepmode = "todate"),
          list(step = "all") # 解除range selection
          )),

      rangeslider = list(type = "date"))
  )
```


## Complete program

```{r}
xgrids <- list(
  gridwidth = 0.1,
  gridcolor = "#434343",
  showgrid = T, showline = T
)
xticks <- list(
  dtick = "M12", # 座標點相隔12個月
  tickformat = "%Y", # 座標只放年
  ticklabelmode = "period"
)
xrangeSelector <- list(
  rangeselector = {
    list(
      buttons = {
        list(
          list(
            count = 3,
            label = "3 mo",
            step = "month",
            stepmode = "backward"
          ),
          list(
            count = 6,
            label = "6 mo",
            step = "month",
            stepmode = "backward"
          ),
          list(
            count = 1,
            label = "1 yr",
            step = "year",
            stepmode = "backward"
          ),
          list(
            count = 1,
            label = "YTD",
            step = "year",
            stepmode = "todate"
          ),
          list(step = "all")
        )
      }
    )
  }
)
xrangeSlider <- list(
  rangeslider = list(type = "date")
)
```


```{r}
df_agPrices |>
plotly::plot_ly() |>
  add_trace(
    type = "scatter", mode = "lines",
    x = ~TIME_PERIOD,
    y = ~Item_VALUE,
    name = ~Item2, # trace名稱, 也是legend label
    split = ~Item2, # 切割trace依據
    color = I("white"),
    legendgroup = ~Cat, # 相同Cat合併成一trace.
    # legendgrouptitle=list(font=list(color="white")),
    hovertemplate = "%{x|%b%Y}",
    line = list(width = 0.3)
  ) |>
  plotly::layout(
    title=list(text="各類食品消費者物價指數",
      font=list(color="white")),
    legend = list(
      orientation = "h", 
      y=-0.2, 
      font=list(color="#e6e6e6"),
      grouptitlefont=list(color="white"),
      title=list(font=list(color="white"))
    ),
    height=600, 
    plot_bgcolor = "black",
    paper_bgcolor = "#c5a880",
    margin=list(t=57),
    yaxis = list(
      gridwidth = 0.1, gridcolor = "#434343",
      showgrid = T, showline = F,
      title = list(text = NULL),
      range = c(0, 250)
    ), # fixed range
    xaxis =
      c(
        list(title=list(text = NULL)),
        xgrids,
        xticks,
        # Range slider and selectors
        xrangeSelector,
        xrangeSlider
      )
  ) |>
  econIDV::add_legendgrouptitle(font=list(color="white")) -> plt_complete
plt_complete
```

## Highlight

Legend ：用來去除不要的traces (single click on legend)或留下要的traces (double click on legend).

Highlight: 用來突顯某些traces (single click on the graph)

```{r}
highlight_agPrices <- plotly::highlight_key(
  df_agPrices, 
  key=~Item2, # 點到one trace，其他key值相同的trace也會被highlight.
  group="Highlight食品名稱"
)
highlight_agPrices |> 
  plot_agprices_complete() |>
  highlight(
    off="plotly_doubleclick",
    selectize=T, # 文字輸入框
    opacityDim=0.9,  # 沒被highlight透明化
    color="red", # 被highlight的顏色
    selected =
      attrs_selected(
        # 被highlight的線粗放大為2
        line=list(width=2),
        # 被highlight的不用顯示他在圖例裡（避免重覆顯示。
        showlegend=FALSE
      ) # 被highlight trace的其他設定
  ) -> plt_highlight
plt_highlight 
```


<div class="alert alert-warning">
有圖例時, 記得設定:
```{r}
attrs_selected(showlegend=FALSE)
```
以免重覆圖例。
</div>

## Custom modebar

  * <https://plotly-r.com/control-modebar.html>
  
  * <https://fonts.google.com/icons>


```{r}
svg='<svg width="26" height="20" viewBox="0 0 26 20" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M9.25 8.75H16.75V5L21.75 10L16.75 15V11.25H9.25V15L4.25 10L9.25 5V8.75ZM0.5 20V0H3V20H0.5ZM23 20V0H25.5V20H23Z" fill="black"/>
</svg>'
```

```{r}
slider <- list(
  name = "slider",
  icon = list(
    svg=htmltools::includeText("/Users/martinl/Downloads/expand.svg")),
  click = htmlwidgets::JS(
    "function() {
       $slider.toggle();
       $rangeSelector.toggle();
    }"
  )
)

plt_highlight %>%
  plotly::config(
    modeBarButtonsToAdd = list(slider)) |>
  tagList(
    tags$style('
      g.rangeslider-container {
        display: none;
        opacity: 0.6;
      }
      g.rangeselector {
        display: none;
      }
      '),
    tags$script('
      $(function(){
        $slider=$("g.rangeslider-container");
        $rangeSelector=$("g.rangeselector");
});
')
  ) -> foodPricesWidget

foodPricesWidget |> econIDV::showWidget()

```

```{r, echo=FALSE}
htmltools::save_html(
    foodPricesWidget,
    file="/Users/martinl/Github/econIDV/docs/foodprices2.html"
  )
```

